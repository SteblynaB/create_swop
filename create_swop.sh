#!/bin/bash

# Выводим информацию о количестве оперативной памяти сервера
echo "Текущая информация о памяти:"
free -h
echo ""

# Запрашиваем размер свопа у пользователя
while true; do
    read -p "Введите размер свопа (например, 4G): " SWAP_SIZE

    # Проверяем, что введенное значение является числом
    if [[ $SWAP_SIZE =~ ^[0-9]+$ ]]; then
        SWAP_SIZE="${SWAP_SIZE}G"  # Добавляем G, если введено только число
        break
    elif [[ $SWAP_SIZE =~ ^[0-9]+[Gg]$ ]]; then
        break  # Если уже указана G, просто выходим из цикла
    else
        echo "Неверный формат. Пожалуйста, введите размер, например: 4G или 512."
    fi
done

# Шаг 1: Создание своп-файла
echo "Создание своп-файла размером $SWAP_SIZE..."
sudo fallocate -l $SWAP_SIZE /swapfile

# Шаг 2: Установка правильных разрешений
echo "Установка прав доступа для своп-файла..."
sudo chmod 600 /swapfile

# Шаг 3: Инициализация свопа
echo "Инициализация свопа..."
sudo mkswap /swapfile

# Шаг 4: Активирование свопа
echo "Активирование своп-файла..."
sudo swapon /swapfile

# Шаг 5: Проверка состояния свопа
echo "Проверка состояния свопа..."
sudo swapon --show
free -h

# Шаг 6: Автоматическое подключение свопа при загрузке
echo "Добавление своп-файла в /etc/fstab для автоматического подключения при загрузке..."
echo "/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab

echo "Скрипт выполнен успешно. Своп-файл создан и настроен!"
sleep 1

htop
